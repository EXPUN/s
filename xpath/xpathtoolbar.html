<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="Access-Control-Allow-Origin" content="*">
<title>xpathtoolbar</title>
<link href="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/bootstrap-v4-rtl/4.6.0-1/css/bootstrap.min.css" rel="stylesheet">
<script src="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.5.1/jquery.min.js"></script>
<script src="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/bootstrap-v4-rtl/4.6.0-1/js/bootstrap.bundle.min.js"></script>
<script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/bootstrap-v4-rtl/4.6.0-1/js/bootstrap.min.js"></script>
<style>
#downloadbtn{
	float:right;
}
.hid{
    display:none;
}
.toolbox {
	position:fixed;
	/*bottom:5px;*/
    top:0px;
	right:0px;
	z-index:900000000;
}
.toolbox_title {
	width:30px;
	height:33px;
	text-align:center;
	display:block;
	float:left;
	cursor:pointer;
	/*background-color:#6c757d;*/
	color:#FFF;
}
.toolbox_title span {
	position:relative;
	top:50%;
	display:block;
	z-index:910000000;
	margin-top:-15px;
}
.toolbox_main {
	width:0px;
	height:33px;
	overflow:hidden;
	float:left;
    padding:1px 0;
	background-color:#FFF;
}
.toolbox_this {
	/*background-color:#343a40;*/
}
}
</style>
</head>
<body>
    <table style="width:100%; table-layout: fixed;">
        <tr style="width:100%;">
            <td style="width:100px;" id="tdinfo">统计信息</td>
            <td style="width:602px;">
                <div class="input-group input-group-sm mb-0" style="width:600px;">
                    <div class="input-group-prepend">
                        <div class="btn-group btn-group-sm rounded-0" id="xpathtypebtngrp">
                            <button type="button" id="xpathtype" data="tuwen" class="btn btn-info rounded-0">图文主体</button>
                                <button type="button" class="btn btn-outline-info hid rounded-0" data ="tuwen">图文主体</button>
                                <button type="button" class="btn btn-outline-info hid rounded-0" data ="links">链接主体</button>
                                <button type="button" class="btn btn-outline-info hid rounded-0" data ="other">其他主体</button>
                                <button type="button" class="btn btn-outline-warning hid rounded-0" data ="nocontent">无主体跳过</button>
                                <button type="button" class="btn btn-outline-warning hid rounded-0" data ="toomore">楼层过多跳过</button>
                                <button type="button" class="btn btn-outline-warning hid rounded-0" data ="odel">其他跳过</button>
                          </div>

                        <!--button type="button" id="xpathtype" data="tuwen" class="rounded-0 btn btn-outline-secondary dropdown-toggle" data-toggle="dropdown">图文主体</button>
                          <div class="dropdown-menu" id="dropdown-menu">
                            <a class="dropdown-item"  id ="tuwen">图文主体</a>
                            <a class="dropdown-item"  id ="links">链接主体</a>
                            <a class="dropdown-item"  id ="other">其他主体</a>
                            <a class="dropdown-item"  id ="nocontent">无主体</a>
                            <a class="dropdown-item"  id ="toomore">楼层过多</a>
                            <a class="dropdown-item"  id ="odel">其他删除</a>
                          </div-->

                        <!--select class="rounded-0 form-control form-control-sm selectpicker" id="sel1">
                            <optgroup label="maincontent">
                                <option value="tuwen" class="dropdown-toggle" data-toggle="dropdown">图文主体</option>
                                <option value="links" class="dropdown-item">链接主体</option>
                                <option value="other" class="dropdown-item">其他主体</option>
                            </optgroup>
                            <optgroup label="del">
                                <option value="nocontent" class="dropdown-item text-warning">无主体</option>
                                <option value="toomore" class="dropdown-item text-warning">楼层过多</option>
                                <option value="odel" class="dropdown-item text-warning">其他剔除</option>
                            </optgroup>
                        </select-->
                    </div>
                    <input type="text" id ="xpathstr" class="form-control" placeholder="请复制full xpath" >
                    <div class="input-group-append">
                        <button class="btn btn-success rounded-0" id="savebtn">save</button>
                        <button class="btn btn-outline-secondary rounded-0" id="addbtn">+</button>
                        <button class="btn btn-outline-danger rounded-0" id="resetbtn">重填</button>
                    </div>
                </div>
            </td>
            <td class="finfo" title="" data="" id ="finfo" style="overflow: hidden;white-space: nowrap;text-overflow: ellipsis;"></td>
            <td style="width:140px;" id="ver">0810-7</td>
        </tr>
    </table>
    <div class="toolbox">
        <strong class="toolbox_title"><span>
            <svg t="1628411507237" class="icon" viewBox="0 0 1097 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11474" width="32" height="32"><path d="M512 512q0-60.571429-42.857143-103.428571t-103.428571-42.857143-103.428572 42.857143-42.857143 103.428571 42.857143 103.428571 103.428572 42.857143 103.428571-42.857143 42.857143-103.428571z m438.857143 292.571429q0-29.714286-21.714286-51.428572t-51.428571-21.714286-51.428572 21.714286-21.714285 51.428572q0 30.285714 21.428571 51.714285t51.714286 21.428572 51.714285-21.428572 21.428572-51.714285z m0-585.142858q0-29.714286-21.714286-51.428571t-51.428571-21.714286-51.428572 21.714286-21.714285 51.428571q0 30.285714 21.428571 51.714286T877.714286 292.571429t51.714285-21.428572T950.857143 219.428571z m-219.428572 240.571429v105.714286q0 5.714286-4 11.142857t-9.142857 6l-88.571428 13.714286q-6.285714 20-18.285715 43.428571 19.428571 27.428571 51.428572 65.714286 4 5.714286 4 11.428571 0 6.857143-4 10.857143-13.142857 17.142857-47.142857 51.142857T570.857143 813.142857q-6.285714 0-12-4l-65.714286-51.428571q-21.142857 10.857143-44 17.714285-6.285714 61.714286-13.142857 88.571429-4 13.714286-17.142857 13.714286H312.571429q-6.285714 0-11.428572-4.285715t-5.714286-10l-13.142857-87.428571q-19.428571-5.714286-42.857143-17.714286l-67.428571 50.857143q-4 4-11.428571 4-6.285714 0-12-4.571428-82.285714-76-82.285715-91.428572 0-5.142857 4-10.857143 5.714286-8 23.428572-30.285714t26.857143-34.857143q-13.142857-25.142857-20-46.857143l-86.857143-13.714285q-5.714286-0.571429-9.714286-5.428572t-4-11.142857V458.285714q0-5.714286 4-11.142857t9.142857-6l88.571429-13.714286q6.285714-20 18.285714-43.428571-19.428571-27.428571-51.428571-65.714286-4-6.285714-4-11.428571 0-6.857143 4-11.428572 12.571429-17.142857 46.857142-50.857142t45.142858-33.714286q6.285714 0 12 4l65.714285 51.428571q19.428571-10.285714 44-18.285714 6.285714-61.714286 13.142857-88 4-13.714286 17.142858-13.714286h106.285714q6.285714 0 11.428571 4.285715t5.714286 10l13.142857 87.428571q19.428571 5.714286 42.857143 17.714286l67.428571-50.857143q4.571429-4 11.428572-4 6.285714 0 12 4.571428 82.285714 76 82.285714 91.428572 0 5.142857-4 10.857143-6.857143 9.142857-24 30.857143t-25.714286 34.285714q13.142857 27.428571 19.428572 46.857143l86.857143 13.142857q5.714286 1.142857 9.714285 6t4 11.142857z m365.714286 304.571429v80q0 9.142857-85.142857 17.714285-6.857143 15.428571-17.142857 29.714286 29.142857 64.571429 29.142857 78.857143 0 2.285714-2.285714 4-69.714286 40.571429-70.857143 40.571428-4.571429 0-26.285714-26.857142t-29.714286-38.857143q-11.428571 1.142857-17.142857 1.142857t-17.142857-1.142857q-8 12-29.714286 38.857143t-26.285714 26.857142q-1.142857 0-70.857143-40.571428-2.285714-1.714286-2.285715-4 0-14.285714 29.142858-78.857143-10.285714-14.285714-17.142858-29.714286-85.142857-8.571429-85.142857-17.714285v-80q0-9.142857 85.142857-17.714286 7.428571-16.571429 17.142858-29.714286-29.142857-64.571429-29.142858-78.857143 0-2.285714 2.285715-4 2.285714-1.142857 20-11.428571t33.714285-19.428572 17.142858-9.142857q4.571429 0 26.285714 26.571429t29.714286 38.571428q11.428571-1.142857 17.142857-1.142857t17.142857 1.142857q29.142857-40.571429 52.571428-64l3.428572-1.142857q2.285714 0 70.857143 40 2.285714 1.714286 2.285714 4 0 14.285714-29.142857 78.857143 9.714286 13.142857 17.142857 29.714286 85.142857 8.571429 85.142857 17.714286z m0-585.142858v80q0 9.142857-85.142857 17.714286-6.857143 15.428571-17.142857 29.714286 29.142857 64.571429 29.142857 78.857143 0 2.285714-2.285714 4-69.714286 40.571429-70.857143 40.571428-4.571429 0-26.285714-26.857143t-29.714286-38.857142q-11.428571 1.142857-17.142857 1.142857t-17.142857-1.142857q-8 12-29.714286 38.857142t-26.285714 26.857143q-1.142857 0-70.857143-40.571428-2.285714-1.714286-2.285715-4 0-14.285714 29.142858-78.857143-10.285714-14.285714-17.142858-29.714286-85.142857-8.571429-85.142857-17.714286V179.428571q0-9.142857 85.142857-17.714285 7.428571-16.571429 17.142858-29.714286-29.142857-64.571429-29.142858-78.857143 0-2.285714 2.285715-4 2.285714-1.142857 20-11.428571t33.714285-19.428572 17.142858-9.142857q4.571429 0 26.285714 26.571429t29.714286 38.571428q11.428571-1.142857 17.142857-1.142857t17.142857 1.142857q29.142857-40.571429 52.571428-64l3.428572-1.142857q2.285714 0 70.857143 40 2.285714 1.714286 2.285714 4 0 14.285714-29.142857 78.857143 9.714286 13.142857 17.142857 29.714286 85.142857 8.571429 85.142857 17.714285z" p-id="11475" fill="#8a8a8a"></path></svg>
        </span></strong>
        <div class="toolbox_main" >
            <span class="input-group input-group-sm mb-1">
                <span class="input-group-prepend">
                    
                    <span class="input-group-text rounded-0">任务ID</span>
                </span>
                <input type="text" class="form-control" placeholder="使用两位数字任务ID-姓名的格式，如 00-姓名" id="myid">
                <span class="input-group-append">
                    <button type="submit" class="btn btn-outline-success rounded-0" id="myidsubmit"><svg t="1627184068520" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8361" width="16" height="16"><path d="M954.857143 323.428571q0 22.857143-16 38.857143l-413.714286 413.714286-77.714286 77.714286q-16 16-38.857142 16t-38.857143-16l-77.714286-77.714286-206.857143-206.857143q-16-16-16-38.857143t16-38.857143l77.714286-77.714285q16-16 38.857143-16t38.857143 16l168 168.571428 374.857142-375.428571q16-16 38.857143-16t38.857143 16l77.714286 77.714286q16 16 16 38.857142z" p-id="8362"></path></svg>提交</button>
                    <button class="btn btn-outline-danger rounded-0" type="button" id="resetidbtn" onclick="document.getElementById('myidsubmit').disabled=false;document.getElementById('myid').disabled=false;deletedb('myid');"><svg t="1627184204403" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8719" width="16" height="16"><path d="M950.857143 512q0 89.142857-34.857143 170.285714t-93.714286 140-140 93.714286-170.285714 34.857143q-98.285714 0-186.857143-41.428572T174.285714 792.571429q-4-5.714286-3.714285-12.857143t4.857142-11.714286l78.285715-78.857143q5.714286-5.142857 14.285714-5.142857 9.142857 1.142857 13.142857 6.857143 41.714286 54.285714 102.285714 84t128.571429 29.714286q59.428571 0 113.428571-23.142858T718.857143 718.857143t62.571428-93.428572T804.571429 512t-23.142858-113.428571T718.857143 305.142857t-93.428572-62.571428T512 219.428571q-56 0-107.428571 20.285715T313.142857 297.714286l78.285714 78.857143q17.714286 17.142857 8 39.428571-9.714286 22.857143-33.714285 22.857143H109.714286q-14.857143 0-25.714286-10.857143t-10.857143-25.714286V146.285714q0-24 22.857143-33.714285 22.285714-9.714286 39.428571 8l74.285715 73.714285q61.142857-57.714286 139.714285-89.428571T512 73.142857q89.142857 0 170.285714 34.857143t140 93.714286 93.714286 140 34.857143 170.285714z" p-id="8720"></path></svg>重填</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary rounded-0" id="downloadbtn" onclick="downloadfunction();"><svg t="1627183789230" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8182" width="16" height="16"><path d="M768 768q0-14.857143-10.857143-25.714286t-25.714286-10.857143-25.714285 10.857143-10.857143 25.714286 10.857143 25.714286 25.714285 10.857143 25.714286-10.857143 10.857143-25.714286z m146.285714 0q0-14.857143-10.857143-25.714286t-25.714285-10.857143-25.714286 10.857143-10.857143 25.714286 10.857143 25.714286 25.714286 10.857143 25.714285-10.857143 10.857143-25.714286z m73.142857-128v182.857143q0 22.857143-16 38.857143t-38.857142 16H91.428571q-22.857143 0-38.857142-16t-16-38.857143v-182.857143q0-22.857143 16-38.857143t38.857142-16h265.714286l77.142857 77.714286q33.142857 32 77.714286 32t77.714286-32l77.714285-77.714286h265.142858q22.857143 0 38.857142 16t16 38.857143z m-185.714285-325.142857q9.714286 23.428571-8 40l-256 256q-10.285714 10.857143-25.714286 10.857143t-25.714286-10.857143L230.285714 354.857143q-17.714286-16.571429-8-40 9.714286-22.285714 33.714286-22.285714h146.285714V36.571429q0-14.857143 10.857143-25.714286t25.714286-10.857143h146.285714q14.857143 0 25.714286 10.857143t10.857143 25.714286v256h146.285714q24 0 33.714286 22.285714z" p-id="8183"></path></svg>导出</button>
                </span>
            </span>
            <a href="javascript:;" class="file rounded-0" style="display:none;">选择文件夹<input id="upfileistbtn" type="file" webkitdirectory="" directory="" onchange="fileChange(this);"></a>
        </div>
    </div>
</body>
<script>
var pageid;
var myid;
var day=currentTime().replace(/月|日.*$/g,"");
window.onload = function() {
    window.parent.postMessage({"onload":"iframe_loaded"},'*');
    //console.log("iframe_loaded");
    window.addEventListener('message', function (e) {  // 监听 message 事件
        //alert(e.origin);
        if(e.source!=window.parent) return;
        //console.log( "从"+ e.origin +"收到消息： " );
        console.log( e.data );
        if (e.data.pageid) {
            pageid=e.data.pageid;
            //console.log(pageid);
            readdb(pageid,function(obj){
                if ("undefined"==typeof(obj) || pageid!=obj.id) return;
                window.parent.postMessage(obj,'*');
                document.getElementById("savebtn").disabled=true;
                document.getElementById("addbtn").disabled=true;
                document.getElementById("xpathstr").disabled=true;
                document.getElementById("xpathstr").value="已完成";
                jQuery(".finfo").attr("data",JSON.stringify(obj));
                jQuery(".finfo").html(normalreader(obj));

            })
        }
    });
    readdb("myid",function(obj){
        if ("undefined"==typeof(obj) || null == obj.idval) {
            if(localStorage.getItem("myid") && null!=localStorage.getItem("myid")){
                writedb({"id":"myid","idval":localStorage.getItem("myid")});
                console.log(localStorage.getItem("myid"));
                jQuery("#myid").val(localStorage.getItem("myid")).attr("disabled",true);
            }else{
                jQuery(".toolbox_title").click();
                console.log("请输入任务ID");
            }
        }
        else{
            //console.log(obj);
            myid = obj.idval;
            jQuery("#myid").val(myid).attr("disabled",true);
        }
    }); 


    $("#xpathtype").click(function(){
        $("#xpathtype ~ button[class*='btn-outline'],#xpathstr,.input-group-append>button").toggleClass("hid");
    });

    $("#xpathtype ~ button[class*='btn-outline']").click(function(){
        $("#xpathtype").text($(this).text()).attr("data",$(this).attr("data"));
        $("#xpathtype ~ button[class*='btn-outline'],#xpathstr,.input-group-append>button").toggleClass("hid");
    });

    /*jQuery("#xpathstr").change(function(){
        //console.log("checkitsright btn clicked!");
        if ($("#xpathstr").val().trim() && !$("#xpathstr").val().trim().match(/[,，]$/)){
            window.parent.postMessage(crejson(),'*');
        }
    });*/
    
    jQuery("#addbtn").click(function(){
        let obj = crejson();
        if (pageid==obj.id){
            window.parent.postMessage(obj,'*');
        }
    });

    jQuery("#savebtn").click(function(){
        //let obj = jQuery("#finfo").attr("data")? JSON.parse(jQuery("#finfo").attr("data")) :crejson();
        let obj =crejson();
        if (pageid==obj.id){
            writedb(obj,function(){readdb(pageid)});   //触发一次change和一次click,会重复
            window.parent.postMessage(obj,'*');
        }
        document.getElementById("savebtn").disabled=true;
        document.getElementById("addbtn").disabled=true;
        document.getElementById("xpathstr").disabled=true;
    });

    jQuery("#resetbtn").click(function(){
        document.getElementById("savebtn").disabled=false;
        document.getElementById("addbtn").disabled=false;
        document.getElementById("xpathstr").value="";
        document.getElementById("xpathstr").disabled=false;
        document.getElementById("finfo").innerHTML="";
        document.getElementById("finfo").getAttributeNode("data").value="";
        document.getElementById("finfo").getAttributeNode("title").value="";
        deletedb(pageid);
        window.parent.postMessage({"cmd":"removecss"},'*');
    });

    jQuery("body").on("click","#downloadbtn",function(){
        downloadfunction(function(txt){
            //console.log(txt);
            download(myid+"-"+currentTime().replace(/月|日.*$/g,"")+"-导出数据_"+currentTime()+".csv",txt);
        });
    }); 
}
function crejson(){
    var jsonobj;
    if (jQuery(".finfo").attr("data").trim()) {
        jsonobj=JSON.parse(jQuery(".finfo").attr("data").trim());
    }else{
        jsonobj={"id":"","tuwenstr":"null","linksstr":"null","otherstr":"null","delstr":"null","author":"","day":"","checkinfo":""};
    }
    jsonobj.author = myid;
    jsonobj.day = day;
    jsonobj.id = pageid;

    let xpathtype = $("#xpathtype").attr("data");
    let nowinputstr=$("#xpathstr").val().replace(/,|，/g,"|");
    switch(xpathtype)
    {
        case "tuwen":
            jsonobj.tuwenstr = ("null"== jsonobj.tuwenstr || nowinputstr==jsonobj.tuwenstr)? nowinputstr:jsonobj.tuwenstr+"|"+nowinputstr;
            break;

        case "links":
            jsonobj.linksstr = ("null"== jsonobj.linksstr || nowinputstr==jsonobj.linksstr)? nowinputstr:jsonobj.linksstr+"|"+nowinputstr;
            break;

        case "other":
            jsonobj.otherstr = ("null"== jsonobj.otherstr || nowinputstr==jsonobj.otherstr)? nowinputstr:jsonobj.otherstr+"|"+nowinputstr;
            break;

        case "nocontent":
            jsonobj.delstr = "nocontent";
            break;
        case "toomore":
            jsonobj.delstr = "toomore";
            break;
        case "odel":
            jsonobj.delstr = "odel";
            break;
        default:
            break;
    }

    /*
    if("tuwen"==$("#xpathtype").attr("data")) jsonobj.tuwenstr = ("null"== jsonobj.tuwenstr || $("#xpathstr").val().replace(/,|，/g,"|")==jsonobj.tuwenstr)? $("#xpathstr").val().replace(/,|，/g,"|"):jsonobj.tuwenstr+"|"+$("#xpathstr").val().replace(/,|，/g,"|");
    if("links"==$("#xpathtype").attr("data")) jsonobj.linksstr = ("null"== jsonobj.linksstr || $("#xpathstr").val().replace(/,|，/g,"|")==jsonobj.linksstr)? $("#xpathstr").val().replace(/,|，/g,"|"):jsonobj.linksstr+"|"+$("#xpathstr").val().replace(/,|，/g,"|");
    if("other"==$("#xpathtype").attr("data")) jsonobj.otherstr = ("null"== jsonobj.otherstr || $("#xpathstr").val().replace(/,|，/g,"|")==jsonobj.otherstr)? $("#xpathstr").val().replace(/,|，/g,"|"):jsonobj.otherstr+"|"+$("#xpathstr").val().replace(/,|，/g,"|");
    if("nocontent"==$("#xpathtype").attr("data")) jsonobj.delstr = "nocontent";
    if("toomore"==$("#xpathtype").attr("data")) jsonobj.delstr = "toomore";
    if("odel"==$("#xpathtype").attr("data")) jsonobj.delstr = "odel";
    */
    //jsonobj = JSON.parse(JSON.stringify(jsonobj).replace(/,|，/g,"|"));
    jQuery("#finfo").attr("data",JSON.stringify(jsonobj));
    jQuery("#finfo").attr("title",JSON.stringify(jsonobj));
    jQuery("#finfo").html(normalreader(jsonobj));
    return(jsonobj);
    //if jQuery()
}

/*可视化读取*/
function normalreader(obj){
		obj = ("object" != typeof obj)?JSON.parse(obj):obj;
		let resultstr="";
		if ("null"!= obj.tuwenstr) resultstr+="图文："+obj.tuwenstr+";";
		if ("null"!= obj.linksstr) resultstr+="链接："+obj.linksstr+";";
		if ("null"!= obj.otherstr) resultstr+="其他："+obj.otherstr+";";
		if ("null"!= obj.delstr) resultstr+="删除："+obj.delstr+";";
		return(resultstr);
	}

/*inputfile*/
/*
    var openFile = function(event) {
    var input = event.target;
    var reader = new FileReader();
    reader.onload = function() {
        if(reader.result) {
            //显示文件内容
            //$("#output").html(reader.result);
            //console.log(reader.result);
            let arr = reader.result.split(/\r?\n/);

            writedb(arr,function(countsuc){console.log(countsuc)});
            //for (i in arr){
                //console.log(arr[i]);
            //    let obj = str2json(arr[i]);
            //    if (obj.id) writedb(obj);
            //}
        }
    };
    reader.readAsText(input.files[0]);
    };
*/
  /*myidsubmit*/
$("#myidsubmit").click(function(){
        if (!$("#myid").val().match(/^\d\d\-.{2,4}$/)){
            $("#myid").val("请使用2位数字id-姓名的方式填写任务ID，例如：99-张三丰");
        }else{
            $(this).attr("disabled",true);
            $("#myid").attr("disabled",true);
            writedb({"id":"myid","idval":$("#myid").val()});
        }
    });

function writedb(obj,callback){ //indexdb
    /*创建indexdb*/
    var request = indexedDB.open("mydb", 1);
    request.onerror = function(e) {
        console.log(e.currentTarget.error.message);
    };

    request.onsuccess = function(e) {
       var db = e.target.result;
        console.log('成功打开DB');
    };

    request.addEventListener('upgradeneeded', e => {
        var db = e.target.result;
        if (!db.objectStoreNames.contains('xpath')) {
            console.log("我需要创建一个新的存储对象");
            //如果表格不存在，创建一个新的表格（keyPath，主键 ； autoIncrement,是否自增），会返回一个对象（objectStore）
            var objectStore = db.createObjectStore('xpath', {
                keyPath: "id",
                autoIncrement: false
            });
            objectStore.createIndex("tuwenstr", "tuwenstr", { unique: false });
            objectStore.createIndex("linksstr", "linksstr", { unique: false });
            objectStore.createIndex("otherstr", "otherstr", { unique: false });
            objectStore.createIndex("delstr", "delstr", { unique: false });
            objectStore.createIndex("author", "author", { unique: false });
            objectStore.createIndex("day", "day", { unique: false });
            objectStore.createIndex("checkinfo", "checkinfo", { unique: false });
            console.log('创建对象仓库成功');
        }
    });
    request.addEventListener('success', e => {
        var db = e.target.result;
            var tx = db.transaction('xpath', 'readwrite');
            var store = tx.objectStore('xpath');
            //console.log(typeof arr[i]);
            let jsonobj = obj;
            if (jsonobj.id) {
                if ("myid"==jsonobj.id){
                    var reqAdd = store.add({
                        'id': jsonobj.id,
                        'idval': jsonobj.idval
                    });
                    reqAdd.addEventListener('error', err => {
                        jQuery("#ver").html("写入id失败！");
                    })
                }
                else{
                    var reqAdd = store.add({
                        'id': jsonobj.id,
                        'tuwenstr': jsonobj.tuwenstr,
                        'linksstr': jsonobj.linksstr,
                        'otherstr':jsonobj.otherstr,
                        'delstr':jsonobj.delstr,
                        'author':jsonobj.author,
                        'day':jsonobj.day,
                        'checkinfo':jsonobj.checkinfo
                    });
                    reqAdd.addEventListener('success', e => {
                        console.log("write db suc")
                    })
                    reqAdd.addEventListener('error', err => {
                        console.log("write db err")
                        jQuery("#ver").html("写入失败！");
                    })
                }
            }
        if(typeof callback ==="function"){callback()}
    });
}

function readdb(id,callback){
    var request = indexedDB.open("mydb", 1);

    request.addEventListener('upgradeneeded', e => {
        var db = e.target.result;
        if (!db.objectStoreNames.contains('xpath')) {
            console.log("我需要创建一个新的存储对象");
            //如果表格不存在，创建一个新的表格（keyPath，主键 ； autoIncrement,是否自增），会返回一个对象（objectStore）
            var objectStore = db.createObjectStore('xpath', {
                keyPath: "id",
                autoIncrement: false
            });
            objectStore.createIndex("tuwenstr", "tuwenstr", { unique: false });
            objectStore.createIndex("linksstr", "linksstr", { unique: false });
            objectStore.createIndex("otherstr", "otherstr", { unique: false });
            objectStore.createIndex("delstr", "delstr", { unique: false });
            objectStore.createIndex("author", "author", { unique: false });
            objectStore.createIndex("day", "day", { unique: false });
            objectStore.createIndex("checkinfo", "checkinfo", { unique: false });
            console.log('创建对象仓库成功');
        }
    });
    request.addEventListener('success', e => {
        var db = e.target.result;
        var tx = db.transaction('xpath', 'readwrite');
        var store = tx.objectStore('xpath');
        var reqGet = store.get(id);
        reqGet.addEventListener('success', e => {
            //console.log(reqGet.result);
            let reobj = reqGet.result;
            //return(reobj);
            if (typeof callback ==="function") {
                callback(reobj);
            }
        })
        var allRecords = store.getAll();
        allRecords.onsuccess = function() {
            //console.log(allRecords.result.length);
            jQuery("#tdinfo").html("共"+allRecords.result.length+"条数据");
        };

        var dayindex = store.index("day");
        /*dayindex.count(day).onsuccess = function(event) {
            console.log(event.target.result);
        };
        dayindex.getAllKeys(day).onsuccess = function(event) {
            console.log(event.target.result);
        };*/
        let daycount =0;
        dayindex.openCursor().onsuccess = function(event) {
            var cursor = event.target.result;
            if(cursor) {
                if ("null" == cursor.value.delstr && cursor.value.day==day && "myid"!=cursor.value.id) daycount +=1;
                //console.log(cursor);
                cursor.continue();
            } else {
                jQuery("#tdinfo").html("今日"+daycount);//console.log(daycount);
            }
        };


    });

}

function updatedb(obj,callback){
    var request = indexedDB.open("mydb", 1);
    request.onsuccess = function(e) {
        var db = e.target.result;
        //console.log('成功打开DB');
        var transaction = db.transaction('xpath', 'readwrite');
        var store = transaction.objectStore('xpath');
        console.log(obj);
        var reqUp = store.get(obj.id);
        reqUp.onsuccess = function(e) {
            var data = e.target.result;
            //for (a in newData) {
            //除了keypath之外
            //    data.a = newData.a;
            //}
            console.log(data);
            data.tuwenstr = obj.tuwenstr;
            data.linksstr = obj.linksstr;
            data.otherstr = obj.otherstr;
            data.delstr = obj.delstr;
            data.author = obj.author;
            data.day = obj.day;
            //data.checkinfo = checkinfo;
            store.put(data);
            if (typeof callback ==="function") {
                callback();
            }
        reqUp.onerror = function(){
            console.log("写错误");
            jQuery("#ver").html("更新失败！");
            }
        };
    };
}

function deletedb(pageid,callback){
    var request = indexedDB.open("mydb", 1);
    request.onsuccess = function(e) {
        var db = e.target.result;
        //console.log('成功打开DB');
        var transaction = db.transaction('xpath', 'readwrite');
        var store = transaction.objectStore('xpath');
        console.log(pageid);
        var reqDel = store.delete(pageid);
        reqDel.onsuccess = function(e) {
            console.log("Del suc");
        };
        reqDel.onerror = function(){
            console.log("Del err");
            jQuery("#ver").html("删除失败！");
        }
    };
}

function downloadfunction(callback){
    var request = indexedDB.open("mydb", 1);
    request.onsuccess = function(e) {
        var db = e.target.result;
        var transaction = db.transaction('xpath');
        var store = transaction.objectStore('xpath');
        var reqCur = store.openCursor();//打开游标
        var dataList = new Array();
        let txt ="id,tuwen,link,other,delete,author,day,checkinfo\n";
        var i = 0;
        reqCur.onsuccess = function(e) {
            var cursor = e.target.result;
            if (cursor) {
                dataList[i] = cursor.value;
                if("myid"!=dataList[i].id){
                    txt+=dataList[i].id+","+dataList[i].tuwenstr+","+dataList[i].linksstr+","+dataList[i].otherstr+","+dataList[i].delstr+","+dataList[i].author+",'"+dataList[i].day+","+dataList[i].checkinfo+"\n";
                    i++;
                }
                cursor.continue();
            }else{
                //data = dataList;
                if (typeof callback ==="function") {
                    callback(txt);
                }
            }
        };
        //console.log(txt);
    }
}

/*下载*/
function download(filename,content,contentType) {
    //if (!contentType) contentType = 'application/octet-stream';
    //var a = document.createElement('a');
    //var blob = new Blob([content], { 'type': contentType });
    //a.href = window.URL.createObjectURL(blob);
    //a.download = filename;
    //a.click();

    //var uri = 'data:application/csv;charset=utf-8,' + escape(content); //如果数据太多，就会导致无法导出的结果，原因是浏览器对URL的长度有限制，因此要使用Blob对象和window.URL.createObjectURL()方法做一下改造。
    var uri = new Blob(['\ufeff' + content], {type:"text/csv"});
    var link = document.createElement("a");
    //link.href = uri;
    link.href = URL.createObjectURL(uri);
    link.style = "visibility:hidden";
    link.download = filename ;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

/*获取当前时间*/
function currentTime(){
    var d = new Date(),str = '';
    //str += d.getFullYear()+'年';
    str  += (d.getMonth() + 1 <10)?'0'+(d.getMonth() + 1)+'月':d.getMonth() + 1+'月';
    str  += (d.getDate()<10)?'0'+d.getDate()+'日':d.getDate()+'日';
    str += d.getHours()+'时';
    str  += d.getMinutes()+'分';
    str+= d.getSeconds()+'秒';
    return str;
}

/*toolbox*/
var toolbox_status = 0;
$('.toolbox_title').click(function(){
    if (!toolbox_status) {
        toolbox_status = 1;
        $(this).addClass("toolbox_this").next("div").animate({width: '+600px'}, "100");
    }else{
        toolbox_status = 0;
        $(this).removeClass("toolbox_this").next("div").animate({width: '-600px'}, "100");
    }
});

</script>
</html>
