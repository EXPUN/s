<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="Access-Control-Allow-Origin" content="*">
<title>xpathtoolbar</title>
<link href="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/bootstrap-v4-rtl/4.6.0-1/css/bootstrap.min.css" rel="stylesheet">
<script src="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.5.1/jquery.min.js"></script>
<style>
#downloadbtn{
	/*background-color:#FFF;*/
	float:right;
}
.toolbox {
	position:fixed;
	/*bottom:5px;*/
    top:0px;
	right:0px;
	z-index:900000000;
}
.toolbox_title {
	width:30px;
	height:50px;
	text-align:center;
	display:block;
	float:left;
	cursor:pointer;
	background-color:#6c757d;
	color:#FFF;
}
.toolbox_title span {
	position:relative;
	top:50%;
	display:block;
	z-index:910000000;
	margin-top:-15px;
}
.toolbox_main {
	width:0px;
	height:50px;
	overflow:hidden;
	float:left;
	background-color:#CCC;
}
.toolbox_this {
	background-color:#343a40;
}
.toolbox_main textarea {
	width:200px;
	height:525px;
}
</style>
</head>
<body>
    <table style="width:100%">
        <tr style="width:100%;background-color: #EAF2D3;">
            <td style="width:100px;">统计信息</td>
            <td style="width:600px;">
                <div class="input-group input-group-sm mb-0" style="width:600px;">
                    <div class="input-group-prepend">
                        <select class="rounded-0 form-control form-control-sm" id="sel1">
                            <option value="tuwen" class="dropdown-toggle" data-toggle="dropdown">图文主体</option>
                            <option value="links" class="dropdown-item">链接主体</option>
                            <option value="other" class="dropdown-item">其他主体</option>
                            <option value="nocontent" class="dropdown-item text-warning">无主体</option>
                            <option value="toomore" class="dropdown-item text-warning">楼层过多</option>
                            <option value="odel" class="dropdown-item text-warning">其他剔除</option>
                        </select>
                    </div>
                    <input type="text" id ="xpathstr" class="form-control" placeholder="请复制full xpath" >
                    <div class="input-group-append">
                        <button class="btn btn-success rounded-0" >save</button>
                        <button class="btn btn-outline-secondary rounded-0" >+</button>
                    </div>
                </div>
            </td>
            <td class="finfo">123</td>
            <td style="width:100px;">
                <button type="button" class="btn btn-sm btn-secondary rounded-0" id="downloadbtn" onclick="downloadfunction();"><svg t="1627183789230" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8182" width="16" height="16"><path d="M768 768q0-14.857143-10.857143-25.714286t-25.714286-10.857143-25.714285 10.857143-10.857143 25.714286 10.857143 25.714286 25.714285 10.857143 25.714286-10.857143 10.857143-25.714286z m146.285714 0q0-14.857143-10.857143-25.714286t-25.714285-10.857143-25.714286 10.857143-10.857143 25.714286 10.857143 25.714286 25.714286 10.857143 25.714285-10.857143 10.857143-25.714286z m73.142857-128v182.857143q0 22.857143-16 38.857143t-38.857142 16H91.428571q-22.857143 0-38.857142-16t-16-38.857143v-182.857143q0-22.857143 16-38.857143t38.857142-16h265.714286l77.142857 77.714286q33.142857 32 77.714286 32t77.714286-32l77.714285-77.714286h265.142858q22.857143 0 38.857142 16t16 38.857143z m-185.714285-325.142857q9.714286 23.428571-8 40l-256 256q-10.285714 10.857143-25.714286 10.857143t-25.714286-10.857143L230.285714 354.857143q-17.714286-16.571429-8-40 9.714286-22.285714 33.714286-22.285714h146.285714V36.571429q0-14.857143 10.857143-25.714286t25.714286-10.857143h146.285714q14.857143 0 25.714286 10.857143t10.857143 25.714286v256h146.285714q24 0 33.714286 22.285714z" p-id="8183"></path></svg>导出</button>
            </td>
        </tr>
    </table>
    <!--div class="toolbox">
        <strong class="toolbox_title"><span><<</span></strong>
        <div class="toolbox_main" style="width: 0px;">
            <a href="javascript:;" class="file rounded-0" style="display:none;">选择文件夹<input id="upfileistbtn" type="file" webkitdirectory="" directory="" onchange="fileChange(this);"></a>
        </div>
    </div-->

        <!--button type="button" class=" " id="upload" onclick="upfile.click();" style="float:left !important;display:block !important;"><svg t="1627183528476" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="12286" width="16" height="16"><path d="M763.424 841.152q0-14.848-10.848-25.728t-25.728-10.848-25.728 10.848-10.848 25.728 10.848 25.728 25.728 10.848 25.728-10.848 10.848-25.728zM909.728 841.152q0-14.848-10.848-25.728t-25.728-10.848-25.728 10.848-10.848 25.728 10.848 25.728 25.728 10.848 25.728-10.848 10.848-25.728zM982.848 713.152l0 182.848q0 22.848-16 38.848t-38.848 16l-841.152 0q-22.848 0-38.848-16t-16-38.848l0-182.848q0-22.848 16-38.848t38.848-16l244 0q12 32 40.288 52.576t63.136 20.576l146.272 0q34.848 0 63.136-20.576t40.288-52.576l244 0q22.848 0 38.848 16t16 38.848zM797.152 342.848q-9.728 22.848-33.728 22.848l-146.272 0 0 256q0 14.848-10.848 25.728t-25.728 10.848l-146.272 0q-14.848 0-25.728-10.848t-10.848-25.728l0-256-146.272 0q-24 0-33.728-22.848-9.728-22.272 8-39.424l256-256q10.272-10.848 25.728-10.848t25.728 10.848l256 256q17.728 17.152 8 39.424z" p-id="12287"></path></svg>导入</button>
        <input type="file" id="upfile" accept="text/plain" style="display:none;">
        <span id="localinfo" style="line-height: 25px;font-size: 20px;font-weight: bold;padding-left:12px;">当前页面为本地文件！</span>
        <span id="checkinfouserpanel" style="line-height: 25px;font-size: 20px;font-weight: bold;padding-left:12px;">质检标记为正确</span>
        <span id="checkinfo" style="line-height: 25px;float:right;margin-right:12px;">
            <button type="button" class="" id="checkitsright" style="">正确<svg t="1627891706178" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8178" width="16" height="16"><path d="M954.857143 323.428571q0 22.857143-16 38.857143l-413.714286 413.714286-77.714286 77.714286q-16 16-38.857142 16t-38.857143-16l-77.714286-77.714286-206.857143-206.857143q-16-16-16-38.857143t16-38.857143l77.714286-77.714285q16-16 38.857143-16t38.857143 16l168 168.571428 374.857142-375.428571q16-16 38.857143-16t38.857143 16l77.714286 77.714286q16 16 16 38.857142z" p-id="8179" fill="#31b77a"></path></svg></button>
            <button type="button" class="" id="checkitswrong" style="margin-left:12px;">错误<svg t="1627891766395" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8385" width="16" height="16"><path d="M851.428571 755.428571q0 22.857143-16 38.857143l-77.714285 77.714286q-16 16-38.857143 16t-38.857143-16l-168-168-168 168q-16 16-38.857143 16t-38.857143-16l-77.714285-77.714286q-16-16-16-38.857143t16-38.857142l168-168-168-168q-16-16-16-38.857143t16-38.857143l77.714285-77.714286q16-16 38.857143-16t38.857143 16l168 168 168-168q16-16 38.857143-16t38.857143 16l77.714285 77.714286q16 16 16 38.857143t-16 38.857143l-168 168 168 168q16 16 16 38.857142z" p-id="8386" fill="#d81e06"></path></svg></button>
            <button type="button" class="" id="savebtn" style="margin-left:48px;">导出<svg t="1627183789230" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8182" width="16" height="16"><path d="M768 768q0-14.857143-10.857143-25.714286t-25.714286-10.857143-25.714285 10.857143-10.857143 25.714286 10.857143 25.714286 25.714285 10.857143 25.714286-10.857143 10.857143-25.714286z m146.285714 0q0-14.857143-10.857143-25.714286t-25.714285-10.857143-25.714286 10.857143-10.857143 25.714286 10.857143 25.714286 25.714286 10.857143 25.714285-10.857143 10.857143-25.714286z m73.142857-128v182.857143q0 22.857143-16 38.857143t-38.857142 16H91.428571q-22.857143 0-38.857142-16t-16-38.857143v-182.857143q0-22.857143 16-38.857143t38.857142-16h265.714286l77.142857 77.714286q33.142857 32 77.714286 32t77.714286-32l77.714285-77.714286h265.142858q22.857143 0 38.857142 16t16 38.857143z m-185.714285-325.142857q9.714286 23.428571-8 40l-256 256q-10.285714 10.857143-25.714286 10.857143t-25.714286-10.857143L230.285714 354.857143q-17.714286-16.571429-8-40 9.714286-22.285714 33.714286-22.285714h146.285714V36.571429q0-14.857143 10.857143-25.714286t25.714286-10.857143h146.285714q14.857143 0 25.714286 10.857143t10.857143 25.714286v256h146.285714q24 0 33.714286 22.285714z" p-id="8183"></path></svg></button>
        </span-->
</body>
<script>
window.onload = function() {
    window.parent.postMessage({"onload":"iframe_loaded"},'*');
    console.log("iframe_loaded");
    window.addEventListener('message', function (e) {  // 监听 message 事件
        //alert(e.origin);
        if(e.source!=window.parent) return;
        console.log( "从"+ e.origin +"收到消息： " + e.data);
        if (e.data.pageid) console.log(e.data.pageid);
    });
    /*readdb(pageid,function(obj){
        if ("undefined"==typeof(obj)) {jQuery("#checkinfouserpanel").html("未查询到标记记录");}
        else{
            console.log(obj);
            if ("null"!=obj.tuwenstr)  xpathcheck(obj.tuwenstr,"tuwenstr");
            if ("null"!=obj.linksstr)  xpathcheck(obj.linksstr,"linksstr");
            if ("null"!=obj.otherstr)  xpathcheck(obj.otherstr,"otherstr");
            if ("del"==obj.delstr)  jQuery("#checkinfouserpanel").html("此页面被标记为删除");
            if ("right"==obj.checkinfo) jQuery("#checkinfouserpanel").html("质检标记为正确");
            if ("wrong"==obj.checkinfo) jQuery("#checkinfouserpanel").html("质检标记为错误");
        }
    }); */

    jQuery("body").on("click","#checkitsright",function(){
        //console.log("checkitsright btn clicked!");
        updatedb(pageid,"right");
    });

    jQuery("body").on("click","#checkitswrong",function(){
        //console.log("checkitsright btn clicked!");
        updatedb(pageid,"wrong");
    });

    jQuery("body").on("click","#savebtn",function(){
        downloadfunction(function(txt){
            //console.log(txt);
            download("质检-"+currentTime().replace(/月|日.*$/g,"")+"_导出数据_"+currentTime()+".csv",txt);
        });
    }); 
    
    jQuery("#upfile").change(function(){
        //console.log(1);
        openFile(event);
    });
}

    var openFile = function(event) {
    var input = event.target;
    var reader = new FileReader();
    reader.onload = function() {
        if(reader.result) {
            //显示文件内容
            //$("#output").html(reader.result);
            //console.log(reader.result);
            let arr = reader.result.split(/\r?\n/);

            writedb(arr,function(countsuc){console.log(countsuc)});
            //for (i in arr){
                //console.log(arr[i]);
            //    let obj = str2json(arr[i]);
            //    if (obj.id) writedb(obj);
            //}
        }
    };
    reader.readAsText(input.files[0]);
    };
    function writedb(arr,callback){ //indexdb
    /*创建indexdb*/
    var request = indexedDB.open("mydb", 1);
    request.onerror = function(e) {
        console.log(e.currentTarget.error.message);
    };

    request.onsuccess = function(e) {
       var db = e.target.result;
        console.log('成功打开DB');
    };

    request.addEventListener('upgradeneeded', e => {
        var db = e.target.result;
        if (!db.objectStoreNames.contains('xpath')) {
            console.log("我需要创建一个新的存储对象");
            //如果表格不存在，创建一个新的表格（keyPath，主键 ； autoIncrement,是否自增），会返回一个对象（objectStore）
            var objectStore = db.createObjectStore('xpath', {
                keyPath: "id",
                autoIncrement: false
            });
            console.log('创建对象仓库成功');
        }
    });
    request.addEventListener('success', e => {
        var db = e.target.result;
        let countsuc = 0;
        for (i in arr){
            var tx = db.transaction('xpath', 'readwrite');
            var store = tx.objectStore('xpath');
            //console.log(typeof arr[i]);
            let jsonobj = str2json(arr[i]);
            if (jsonobj.id) {
                var reqAdd = store.add({
                    'id': jsonobj.id,
                    'tuwenstr': jsonobj.tuwenstr,
                    'linksstr': jsonobj.linksstr,
                    'otherstr':jsonobj.otherstr,
                    'delstr':jsonobj.delstr,
                    'author':jsonobj.author,
                    'day':jsonobj.day,
                    'checkinfo':jsonobj.checkinfo
                });
                reqAdd.addEventListener('success', e => {
                    countsuc +=1;
                    //jQuery("#localinfo").html("正在导入数据，请勿关闭页面"+(parseInt(i)+1)+"/"+arr.length);
                    jQuery("#localinfo").html("成功导入"+countsuc+"/"+arr.length+"条数据");
                })
                reqAdd.addEventListener('error', err => {
                    //counterr += 1;
                })
            }
        }
        if(typeof callback ==="function"){callback(countsuc)}
    });
}

function readdb(id,callback){
    var request = indexedDB.open("mydb", 1);

    request.addEventListener('upgradeneeded', e => {
        var db = e.target.result;
        if (!db.objectStoreNames.contains('xpath')) {
            console.log("我需要创建一个新的存储对象");
            //如果表格不存在，创建一个新的表格（keyPath，主键 ； autoIncrement,是否自增），会返回一个对象（objectStore）
            var objectStore = db.createObjectStore('xpath', {
                keyPath: "id",
                autoIncrement: false
            });
            console.log('创建对象仓库成功');
        }
    });


    request.addEventListener('success', e => {
        var db = e.target.result;
        var tx = db.transaction('xpath', 'readwrite');
        var store = tx.objectStore('xpath');
        var reqGet = store.get(id);
        reqGet.addEventListener('success', e => {
            //console.log(reqGet.result);
            let reobj = reqGet.result;
            //return(reobj);
            if (typeof callback ==="function") {
                callback(reobj);
            }
        })
        var allRecords = store.getAll();
        allRecords.onsuccess = function() {
            //console.log(allRecords.result.length);
            jQuery("#localinfo").html("共"+allRecords.result.length+"条数据");
        };
    });

}

function updatedb(pageid,checkinfo,callback){
    var request = indexedDB.open("mydb", 1);
    request.onsuccess = function(e) {
        var db = e.target.result;
        //console.log('成功打开DB');
        var transaction = db.transaction('xpath', 'readwrite');
        var store = transaction.objectStore('xpath');
        var reqUp = store.get(pageid);
        reqUp.onsuccess = function(e) {
            var data = e.target.result;
            //for (a in newData) {
            //除了keypath之外
            //    data.a = newData.a;
            //}
            console.log(data);
            data.checkinfo = checkinfo;
            store.put(data);
            if (typeof callback ==="function") {
                callback(reobj);
            }
            if ("right"==checkinfo) jQuery("#checkinfouserpanel").html("质检标记为正确");
            if ("wrong"==checkinfo) jQuery("#checkinfouserpanel").html("质检标记为错误");
        };
    };
}

function downloadfunction(callback){
    var request = indexedDB.open("mydb", 1);
    request.onsuccess = function(e) {
        var db = e.target.result;
        var transaction = db.transaction('xpath');
        var store = transaction.objectStore('xpath');
        var reqCur = store.openCursor();//打开游标
        var dataList = new Array();
        let txt ="id,tuwen,link,other,delete,author,day,checkinfo\n";
        var i = 0;
        reqCur.onsuccess = function(e) {
            var cursor = e.target.result;
            if (cursor) {
                //console.log(cursor.key);
                dataList[i] = cursor.value;
                //console.log(dataList[i].checkinfo);
                txt+=dataList[i].id+","+dataList[i].tuwenstr+","+dataList[i].linksstr+","+dataList[i].otherstr+","+dataList[i].delstr+","+dataList[i].author+","+dataList[i].day+","+dataList[i].checkinfo+"\n";
                i++;
                cursor.continue();
            }else{
                //data = dataList;
                if (typeof callback ==="function") {
                    callback(txt);
                }
            }
        };
        //console.log(txt);
    }
}

/*下载*/
function download(filename,content,contentType) {
    //if (!contentType) contentType = 'application/octet-stream';
    //var a = document.createElement('a');
    //var blob = new Blob([content], { 'type': contentType });
    //a.href = window.URL.createObjectURL(blob);
    //a.download = filename;
    //a.click();

    var uri = 'data:application/csv;charset=utf-8,' + escape(content);
    var link = document.createElement("a");
    link.href = uri;
    link.style = "visibility:hidden";
    link.download = filename ;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

/*获取当前时间*/
function currentTime(){
    var d = new Date(),str = '';
    //str += d.getFullYear()+'年';
    str  += (d.getMonth() + 1 <10)?'0'+(d.getMonth() + 1)+'月':d.getMonth() + 1+'月';
    str  += (d.getDate()<10)?'0'+d.getDate()+'日':d.getDate()+'日';
    str += d.getHours()+'时';
    str  += d.getMinutes()+'分';
    str+= d.getSeconds()+'秒';
    return str;
}

/*toolbox*/
var toolbox_status = 0;
$('.toolbox_title').click(function(){
    if (!toolbox_status) {
        toolbox_status = 1;
        $(this).addClass("toolbox_this").html("<span>>></span>").next("div").animate({width: '+400px'}, "100");
    }else{
        toolbox_status = 0;
        $(this).removeClass("toolbox_this").html("<span><<</span>").next("div").animate({width: '-400px'}, "100");
    }
});

</script>
</html>
